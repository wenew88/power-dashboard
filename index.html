<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Plant Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .result-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
        }
        .result-item h3 {
            margin-top: 0;
            color: #333;
        }
        .error {
            background-color: #fee2e2;
            color: #dc2626;
            padding: 10px;
            border-radius: 4px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Power Plant Analytics Dashboard</h1>
        
        <div class="card">
            <h2>Input Parameters</h2>
            <div class="input-group">
                <label>Base Price</label>
                <input type="number" id="basePrice" value="4400">
            </div>
            <div class="input-group">
                <label>Gas Price</label>
                <input type="number" id="gasPrice" value="0">
            </div>
            <div class="input-group">
                <label>Efficiency</label>
                <input type="number" id="efficiency" value="0">
            </div>
            <div class="input-group">
                <label>Heat Output</label>
                <input type="number" id="heatOutput" value="0">
            </div>
            <div class="input-group">
                <label>Heat Price</label>
                <input type="number" id="heatPrice" value="0">
            </div>
            <div class="input-group">
                <label>Gas Consumption</label>
                <input type="number" id="gasConsumption" value="0">
            </div>
            <div class="input-group">
                <label>Expenses</label>
                <input type="number" id="expenses" value="195324">
            </div>
            <div class="input-group">
                <label>Excel File (with hourly prices)</label>
                <input type="file" id="excelFile" accept=".xlsx,.xls">
            </div>
        </div>

        <div id="results" class="card" style="display: none;">
            <h2>Results</h2>
            <div class="results" id="resultsGrid">
                <!-- Results will be inserted here -->
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>
    </div>

    <script>
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet2 = workbook.Sheets['Sheet2'];
                    const jsonData = XLSX.utils.sheet_to_json(sheet2, { header: 1 });
                    
                    processData(jsonData);
                } catch (err) {
                    showError('Error processing file. Please ensure correct format.');
                    console.error(err);
                }
            };

            reader.readAsArrayBuffer(file);
        });

        function getInputs() {
            return {
                basePrice: Number(document.getElementById('basePrice').value),
                gasPrice: Number(document.getElementById('gasPrice').value),
                efficiency: Number(document.getElementById('efficiency').value),
                heatOutput: Number(document.getElementById('heatOutput').value),
                heatPrice: Number(document.getElementById('heatPrice').value),
                gasConsumption: Number(document.getElementById('gasConsumption').value),
                expenses: Number(document.getElementById('expenses').value)
            };
        }

        function calculateDerivedValues(inputs) {
            const gasConsumptionHour = inputs.gasConsumption * 3.6;
            const gasCostHour = gasConsumptionHour * inputs.gasPrice;
            const heatRevenue = inputs.heatOutput * inputs.heatPrice;
            const operatingCostHour = gasCostHour - heatRevenue;
            return { gasConsumptionHour, gasCostHour, heatRevenue, operatingCostHour };
        }

        function processData(jsonData) {
            const inputs = getInputs();
            const derived = calculateDerivedValues(inputs);
            
            let profitable_hours = 0;
            let total_revenue = 0;
            let peak_price = 0;
            let peak_hour = '';

            for (let row = 1; row < jsonData.length; row++) {
                for (let col = 1; col < jsonData[row].length; col++) {
                    const price = jsonData[row][col];
                    const hourlyProfit = price - inputs.basePrice - derived.operatingCostHour;
                    
                    if (price > 5000) {
                        profitable_hours++;
                        total_revenue += hourlyProfit;
                        
                        if (price > peak_price) {
                            peak_price = price;
                            peak_hour = `Day ${row} Hour ${col}`;
                        }
                    }
                }
            }

            const net_profit = total_revenue - inputs.expenses;

            displayResults({
                profitable_hours,
                total_revenue,
                net_profit,
                peak_price,
                peak_hour,
                derived
            });
        }

        function displayResults(results) {
            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = '';

            // Add main results
            addResultItem('Profitable Hours', results.profitable_hours);
            addResultItem('Total Revenue', results.total_revenue.toFixed(2));
            addResultItem('Net Profit', results.net_profit.toFixed(2));
            addResultItem('Peak Price', results.peak_price + '<br><small>' + results.peak_hour + '</small>');

            // Add derived values
            Object.entries(results.derived).forEach(([key, value]) => {
                const label = key.replace(/([A-Z])/g, ' $1').toUpperCase();
                addResultItem(label, value.toFixed(2));
            });

            document.getElementById('results').style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }

        function addResultItem(label, value) {
            const div = document.createElement('div');
            div.className = 'result-item';
            div.innerHTML = `<h3>${label}</h3><p>${value}</p>`;
            document.getElementById('resultsGrid').appendChild(div);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('results').style.display = 'none';
        }
    </script>
</body>
</html>
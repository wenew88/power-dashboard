<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Plant Economic Analysis Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Custom Styles -->
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        table {
            font-size: 12px;
        }
        input, select {
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 4px;
        }
        .text-danger { color: #dc3545; }
        .text-success { color: #28a745; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Mock fs API for file reading -->
    <script>
        window.fs = {
            readFile: async (filename) => {
                try {
                    const response = await fetch(filename);
                    const text = await response.text();
                    return new TextEncoder().encode(text);
                } catch (error) {
                    console.error('Error reading file:', error);
                    throw error;
                }
            }
        };
    </script>

    <!-- React Component Script -->
    <script type="text/babel">
        // Import React components and hooks
        const { useState, useEffect } = React;
        
        // Card components
        const Card = ({ children, className }) => (
            <div className={`bg-white rounded-lg shadow-sm p-4 ${className}`}>
                {children}
            </div>
        );

        const CardHeader = ({ children }) => (
            <div className="mb-4">{children}</div>
        );

        const CardTitle = ({ children }) => (
            <h2 className="text-xl font-semibold">{children}</h2>
        );

        const CardContent = ({ children }) => (
            <div>{children}</div>
        );

        // Main Dashboard Component
        const PowerPlantDashboard = () => {
            // Engine specifications
            const engineSpecs = {
                wartsila: {
                    name: 'Wärtsilä W16V25SG',
                    power: 3000,
                    consumption: 777,
                    price: 6000000
                },
                dha: {
                    name: 'DHA',
                    power: 315,
                    consumption: 84,
                    price: 2000000
                },
                jenbacher: {
                    name: 'Jenbacher 612',
                    power: 2200,
                    consumption: 444.30,
                    price: 5000000
                }
            };

            // State management
            const [priceData, setPriceData] = useState([]);
            const [inputs, setInputs] = useState({
                engineCount: 1,
                engineType: 'wartsila',
                load: 100,
                gasPrice: 1.0,
                minPrice: 5000
            });

            const [monthlySpending, setMonthlySpending] = useState({
                oil: 32800,
                serviceParts: 41000,
                workers: 49200,
                salaryTaxes: 10824,
                otherExpenses: 61500
            });

            // Load CSV data
            useEffect(() => {
                const loadData = async () => {
                    try {
                        const response = await window.fs.readFile('d24.csv');
                        const text = new TextDecoder().decode(response);
                        
                        Papa.parse(text, {
                            header: true,
                            dynamicTyping: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                setPriceData(results.data);
                            },
                            error: (error) => {
                                console.error('Error parsing CSV:', error);
                            }
                        });
                    } catch (error) {
                        console.error('Error reading file:', error);
                    }
                };

                loadData();
            }, []);

            // Results calculations
            const calculateResults = () => {
                const engine = engineSpecs[inputs.engineType];
                const generation = engine.power * inputs.engineCount * (inputs.load / 100);
                const consumption = engine.consumption * inputs.engineCount * (inputs.load / 100);
                const investment = engine.price * inputs.engineCount * 1.2;
                const kWePrice = investment / generation;
                const mWePrice = kWePrice * 1000;

                return {
                    generation,
                    consumption,
                    investment,
                    kWePrice,
                    mWePrice
                };
            };

            // Price and financial analysis
            const calculateAnalysis = () => {
                const results = calculateResults();
                
                // Calculate hours above minimum price
                const hoursAboveMin = priceData.reduce((count, day) => {
                    return count + Object.values(day).filter(price => price > inputs.minPrice).length;
                }, 0);

                // Calculate LCOE
                const pricesAboveMin = priceData.flatMap(day => 
                    Object.values(day).filter(price => price > inputs.minPrice)
                );
                
                const lcoe = pricesAboveMin.length > 0 
                    ? pricesAboveMin.reduce((sum, price) => sum + price, 0) / pricesAboveMin.length 
                    : 0;

                // Calculate availability
                const totalHours = 24 * 365;
                const availability = (hoursAboveMin / totalHours) * 100;

                // Financial calculations
                const grossIncome = results.generation * lcoe * hoursAboveMin;
                const monthlySpendingTotal = Object.values(monthlySpending).reduce((a, b) => a + b, 0);
                const monthlyRevenue = grossIncome / 12 - monthlySpendingTotal;
                const annualRevenue = grossIncome - (monthlySpendingTotal * 12);

                // Performance metrics
                const vat = monthlyRevenue * 0.2;
                const reInvestment = monthlyRevenue > 0 ? monthlyRevenue * 0.1 : 0;
                const paybackPeriod = results.investment / (monthlyRevenue > 0 ? monthlyRevenue : 1);
                const roe = (annualRevenue / results.investment) * 100;
                const roa = (annualRevenue / (results.investment * 1.2)) * 100;

                return {
                    hoursAboveMin,
                    lcoe,
                    grossIncome,
                    monthlyRevenue,
                    annualRevenue,
                    vat,
                    reInvestment,
                    paybackPeriod,
                    roe,
                    roa,
                    availability
                };
            };

            const handleInputChange = (field, value) => {
                setInputs(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            const handleSpendingChange = (field, value) => {
                setMonthlySpending(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            const results = calculateResults();
            const analysis = calculateAnalysis();

            return (
                <div className="min-h-screen bg-gray-100 p-4">
                    <div className="max-w-7xl mx-auto">
                        <h1 className="text-2xl font-bold mb-6">Power Plant Economic Analysis Dashboard</h1>
                        
                        {/* Variable Inputs Section */}
                        <Card className="mb-6">
                            <CardHeader>
                                <CardTitle>Variable Inputs</CardTitle>
                            </CardHeader>
                            <CardContent>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Number of Engines</label>
                                        <input
                                            type="number"
                                            min="1"
                                            value={inputs.engineCount}
                                            onChange={(e) => handleInputChange('engineCount', Math.max(1, parseInt(e.target.value)))}
                                            className="w-full p-2 border rounded"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Engine Type</label>
                                        <select
                                            value={inputs.engineType}
                                            onChange={(e) => handleInputChange('engineType', e.target.value)}
                                            className="w-full p-2 border rounded"
                                        >
                                            <option value="wartsila">Wärtsilä W16V25SG</option>
                                            <option value="dha">DHA</option>
                                            <option value="jenbacher">Jenbacher 612</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Load (%)</label>
                                        <input
                                            type="number"
                                            min="0"
                                            max="100"
                                            value={inputs.load}
                                            onChange={(e) => handleInputChange('load', Math.min(100, Math.max(0, parseFloat(e.target.value))))}
                                            className="w-full p-2 border rounded"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Gas Price (per m³)</label>
                                        <input
                                            type="number"
                                            min="0"
                                            step="0.1"
                                            value={inputs.gasPrice}
                                            onChange={(e) => handleInputChange('gasPrice', parseFloat(e.target.value))}
                                            className="w-full p-2 border rounded"
                                        />
                                    </div>
                                </div>
                            </CardContent>
                        </Card>

                        {/* Results Section */}
                        <Card className="mb-6">
                            <CardHeader>
                                <CardTitle>Results</CardTitle>
                            </CardHeader>
                            <CardContent>
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium">Generation (kWe)</label>
                                        <div className="text-lg">{results.generation.toFixed(2)}</div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium">Consumption (m³)</label>
                                        <div className="text-lg">{results.consumption.toFixed(2)}</div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium">Investment+20%</label>
                                        <div className="text-lg">{results.investment.toLocaleString()}</div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium">1 kWe Price</label>
                                        <div className="text-lg">{results.kWePrice.toFixed(2)}</div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium">1 MWe Price</label>
                                        <div className="text-lg">{results.mWePrice.toFixed(2)}</div>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>

                        {/* Monthly Spending Section */}
                        <Card className="mb-6">
                            <CardHeader>
                                <CardTitle>Monthly Spending</CardTitle>
                            </CardHeader>
                            <CardContent>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Oil</label>
                                        <input
                                            type="number"
                                            value={monthlySpending.oil}
                                            onChange={(e) => handleSpendingChange('oil', parseFloat(e.target.value))}
                                            className="w-full p-2 border rounded"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Service and Parts</label>
                                        <input
                                            type="number"
                                            value={monthlySpending.serviceParts}
                                            onChange={(e) => handleSpendingChange('serviceParts', parseFloat(e.target.value))}
                                            className="w-full p-2 border rounded"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Workers (3)</label>
                                        <input
                                            type="number"
                                            value={monthlySpending.workers}
                                            onChange={(e) => handleSpendingChange('workers', parseFloat(e.target.value))}
                                            className="w-full p-2 border rounded"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Salary Taxes (22%)</label>
                                        <input
                                            type="number"
                                            value={monthlySpending.salaryTaxes}
                                            onChange={(e) => handleSpendingChange('salaryTaxes', parseFloat(e.target.value))}
                                            className="w-full p-2 border rounded"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Other Expenses</label>
                                        <input
                                            type="number"
                                            value={monthlySpending.otherExpenses}
                                            onChange={(e) => handleSpendingChange('otherExpenses', parseFloat(e.target.value))}
                                            className="w-full p-2 border rounded"
                                        />
                                    </div>
                                </div>
                            </CardContent>
                        </Card>

                        {/* Price Analysis Section */}
                        <Card className="mb-6">
                            <CardHeader>
                                <CardTitle>Price Analysis</CardTitle>
                            </CardHeader>
                            <CardContent>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Minimum Price</label>
                                        <input
                                            type="number"
                                            value={inputs.minPrice}
                                            onChange={(e) => handleInputChange('minPrice', parseFloat(e.target.value))}
                                            className="w-full p-2 border rounded"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Hours Above Minimum Price</label>
                                        <div className="text-lg">{analysis.hoursAboveMin}</div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">LCOE</label>
                                        <div className="text-lg">{analysis.lcoe.toFixed(2)}</div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Total Income</label>
                                        <div className="text-lg">{analysis.grossIncome.toLocaleString()}</div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Monthly Revenue</label>
                                        <div className="text-lg">{analysis.monthlyRevenue.toLocaleString()}</div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">VAT (20%)</label>
                                        <div className={`text-lg ${analysis.vat < 0 ? 'text-danger' : analysis.vat > 0 ? 'text-success' : ''}`}>
                                            {analysis.vat.toLocaleString()}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Re-Investment</label>
                                        <div className="text-lg">
                                            {analysis.reInvestment > 0 ? '+' : ''}{analysis.reInvestment.toLocaleString()}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Payback Period (months)</label>
                                        <div className="text-lg">
                                            {analysis.paybackPeriod > 12 ? '>12' : analysis.paybackPeriod.toFixed(1)}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">ROE (Return on Equity)</label>
                                        <div className="text-lg">{analysis.roe.toFixed(2)}%</div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">ROA (Return on Assets)</label>
                                        <div className="text-lg">{analysis.roa.toFixed(2)}%</div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Plant Availability</label>
                                        <div className="text-lg">{analysis.availability.toFixed(2)}%</div>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>
                    </div>
                </div>
            );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PowerPlantDashboard />);
    </script>
</body>
</html>